version: "3.8"

services:
  devcontainer:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/workspace:cached
    command: >
      /bin/bash -c "
      source /workspace/venv/bin/activate &&
      for project_dir in /workspace/p_[0-9]*_*; do
        if [ -d \"$$project_dir/tests\" ]; then
          echo \"Running tests for $$(basename $$project_dir)...\";
          export PYTHONPATH=\"$$project_dir:$$PYTHONPATH\";
          pytest \"$$project_dir/tests/\" -v;
          export PYTHONPATH=$${PYTHONPATH//$$project_dir:/};
        fi;
      done"
    working_dir: /workspace
